
---
title: "高级查询"
date: 2019-12-05
author: "Iven"
draft: true
weight: 101
---

## 查询顺序
```text
(7)     SELECT 
(8)     DISTINCT <select_list>
(1)     FROM <left_table>
(3)     <join_type> JOIN <right_table>
(2)     ON <join_condition>
(4)     WHERE <where_condition>
(5)     GROUP BY <group_by_list>
(6)     HAVING <having_condition>
(9)     ORDER BY <order_by_condition>
(10)    LIMIT <limit_number>
```

## 视图
```text
CREATE [ OR REPLACE ] [ TEMP | TEMPORARY ] [ RECURSIVE ] VIEW name [ ( column_name [, ...] ) ]
AS query
[ WITH [ CASCADED | LOCAL ] CHECK OPTION ]
```



**CHECK OPTION**  
WITH CASCADED CHECK OPTION 和 WITH LOCAL CHECK OPTION区别是前者会检查自己得条件同时级联往下检查视图得条件是否满足，后者是只是检查自己得条件是否满足
另外CHECK OPTION不应该和RECURSIVE视图一起使用

- 对于update,有with check option，要保证update后，数据要被视图查询出来  
- 对于delete,有无with check option都一样  
- 对于insert,有with check option，和update相同 要保证insert后，数据要被视图查询出来  
- 对于没有where子句的视图，也就没有视图自己的约束，因此使用with check option是多余的  

> 当使用CREATE VIEW OR REPLACE VIEW修改某字段名、中间增加字段、删除字段时候常常报"cannot change name of view column xxx to yyy"的错误，建议先使用DROP VIEW，然后再CREATE VIEW

## WITH 
with recursive 用法,可以循环调用自己得表
```text
e_commerce=# create table test_area(id int, name varchar(32), fatherid int);
CREATE TABLE
e_commerce=# \d test_area 
                     Table "public.test_area"
  Column  |         Type          | Collation | Nullable | Default 
----------+-----------------------+-----------+----------+---------
 id       | integer               |           |          | 
 name     | character varying(32) |           |          | 
 fatherid | integer               |           |          | 

e_commerce=# insert into test_area values(1, '中国', 0);
INSERT 0 1
e_commerce=# insert into test_area values(2, '安徽', 1);
INSERT 0 1
e_commerce=# insert into test_area values(3, '六安', 2);
INSERT 0 1
e_commerce=# insert into test_area values(4, '顺河', 3);
INSERT 0 1

e_commerce=# with recursive r as(select * from test_area where id=4 
union all 
select test_area.* from  test_area,r where test_area.id = r.fatherid)
e_commerce-# select * from r order by id ;
 id | name | fatherid 
----+------+----------
  1 | 中国 |        0
  2 | 安徽 |        1
  3 | 六安 |        2
  4 | 顺河 |        3

```